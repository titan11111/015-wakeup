<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ã€ç©¶æ¥µã€‘ãƒ©ãƒ³ãƒ€ãƒ è¦šé†’ã‚¢ãƒ©ãƒ¼ãƒ  (iOS/Androidå¯¾å¿œç‰ˆ)</title>
    <style>
        /* --- CSS: ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ --- */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #fff;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
        }
        
        /* å…±é€šã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            width: 90%;
            max-width: 400px;
            text-align: center;
            z-index: 10;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            background-color: #222;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #444;
            box-shadow: 0 4px 15px rgba(255,0,0,0.3);
        }

        input, select {
            padding: 10px;
            font-size: 1.2em;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            margin: 5px;
            width: 80px;
            text-align: center;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        select { width: 200px; text-align: left; }

        button.btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            background: linear-gradient(45deg, #d32f2f, #b71c1c);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #7f0000;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
        }
        button.btn-primary:active { 
            transform: translateY(4px); 
            box-shadow: none; 
        }

        /* iOSéŸ³å£°åˆæœŸåŒ–ãƒœã‚¿ãƒ³ */
        #ios-init {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #ios-init button {
            padding: 20px 40px;
            font-size: 1.5em;
            background: #ff5252;
            border: none;
            color: white;
            border-radius: 10px;
            font-weight: bold;
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¸1: ç®—æ•°ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        #stage-math {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        #math-q { 
            font-size: clamp(2.5em, 8vw, 3.5em); 
            margin-bottom: 20px; 
            color: #ffeb3b; 
            font-weight: bold; 
        }
        #math-a { 
            font-size: 2em; 
            width: 150px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .error-msg { 
            color: #ff4d4d; 
            font-weight: bold; 
            height: 1.2em;
            font-size: 1.1em;
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¸2A: ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  (é€ƒèµ°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ) --- */
        #stage-game {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(20, 0, 0, 0.9);
            z-index: 100;
        }
        #game-bg-click-area {
            width: 100%; height: 100%;
            position: absolute;
            top: 0; left: 0;
        }
        #game-target-btn {
            position: absolute;
            width: clamp(100px, 25vw, 120px);
            height: clamp(100px, 25vw, 120px);
            border-radius: 50%;
            background: radial-gradient(circle, #00e676 0%, #00600f 100%);
            border: 3px solid #fff;
            box-shadow: 0 0 20px #00e676;
            color: white;
            font-weight: bold;
            font-size: clamp(1em, 3vw, 1.2em);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            user-select: none;
            transition: top 0.1s, left 0.1s;
            -webkit-tap-highlight-color: rgba(0, 230, 118, 0.5);
        }
        #game-status {
            position: absolute;
            top: 20px; left: 0; width: 100%;
            text-align: center;
            font-size: clamp(1.2em, 4vw, 1.5em);
            color: white;
            pointer-events: none;
            z-index: 160;
            text-shadow: 0 2px 4px #000;
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¸2B: é…è‰²ãƒ‘ã‚ºãƒ« --- */
        #stage-color {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        #color-pattern-display {
            width: clamp(200px, 60vw, 250px);
            height: 50px; 
            margin: 15px auto; 
            border: 2px solid #fff;
            overflow: hidden;
            text-align: center;
        }
        #color-input-grid {
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            width: clamp(200px, 60vw, 250px);
            margin: 20px auto;
        }
        #color-input-grid button {
            height: clamp(45px, 12vw, 50px);
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            box-sizing: border-box;
            transition: border 0.1s;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
        }
        .highlight-red { color: #ff4d4d; font-weight: bold; }

        /* éŸ³å£°è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .sound-warning {
            background: #ff1744;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>

    <!-- iOSåˆæœŸåŒ–ç”»é¢ -->
    <div id="ios-init" style="display: none;">
        <h2 style="color: #ff5252; margin-bottom: 20px;">ğŸ”Š éŸ³å£°ã‚’æœ‰åŠ¹åŒ–</h2>
        <p style="color: #ccc; margin-bottom: 30px;">ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„</p>
        <button id="btn-init-audio">éŸ³å£°ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹</button>
    </div>

    <div id="setup-screen" class="container">
        <div class="card">
            <h1 style="color:#ff5252; margin-bottom: 5px;">ğŸ‘¿ ç©¶æ¥µã‚¢ãƒ©ãƒ¼ãƒ </h1>
            <p style="font-size:0.8em; color:#aaa;">ç®—æ•°ã‚¯ãƒªã‚¢å¾Œã€ã‚²ãƒ¼ãƒ ãŒãƒ©ãƒ³ãƒ€ãƒ æ±ºå®š</p>
            
            <div class="sound-warning">
                âš ï¸ iPhoneã®æ–¹ï¼šãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¦ãã ã•ã„
            </div>
            
            <div>
                <label>æ™‚é–“</label>
                <input type="number" id="alarm-h" value="0" min="0" inputmode="numeric">
                <label>åˆ†</label>
                <input type="number" id="alarm-m" value="1" min="0" inputmode="numeric">
            </div>
            
            <div style="margin-top: 15px;">
                <label>éŸ³ãƒ¢ãƒ¼ãƒ‰</label><br>
                <select id="sound-mode">
                    <option value="HEAVY">ğŸ’¥ çˆ†éŸ³ãƒ»é‡ä½éŸ³</option>
                    <option value="MOSQUITO">ğŸ¦Ÿ è„³å†…ç ´å£Šãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆ</option>
                    <option value="SIREN">ğŸš¨ éå¸¸è­¦å ±</option>
                </select>
            </div>
            
            <button id="btn-set" class="btn-primary">ã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="countdown-screen" class="container" style="display: none;">
        <div class="card">
            <h2 style="color:#00e676;">å¾…æ©Ÿä¸­...</h2>
            <div id="timer-display" style="font-size: clamp(2.5em, 7vw, 3.5em); font-family: monospace;">00:00:00</div>
            <p style="color:#ff4d4d; font-weight:bold;">â€»éŸ³é‡ã‚’æœ€å¤§ã«ã—ã¦ãã ã•ã„</p>
            <button id="btn-cancel" style="background:#555; padding:10px; width:100%; border:none; color:white; border-radius:5px;">è§£é™¤</button>
        </div>
    </div>

    <div id="stage-math" style="display: none;">
        <h2 style="color:#ffeb3b;">STAGE 1: è„³ã‚’èµ·ã“ã›</h2>
        <div id="math-q"></div>
        <input type="number" id="math-a" placeholder="ç­”ãˆ" inputmode="numeric">
        <p id="math-msg" class="error-msg"></p>
        <button id="btn-math-submit" class="btn-primary" style="width: 200px;">å›ç­”</button>
    </div>

    <div id="stage-game" style="display: none;">
        <div id="game-status">
            ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ã‚¿ãƒƒãƒ—ã›ã‚ˆ<br>
            æ®‹ã‚Š: <span id="game-count" style="font-size:1.5em;">5</span> å›
            <div style="font-size:0.6em; color:#ff4d4d;">(èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§ãƒªã‚»ãƒƒãƒˆï¼)</div>
        </div>
        <div id="game-bg-click-area"></div>
        <div id="game-target-btn">TAP ME</div>
    </div>
    
    <div id="stage-color" style="display: none;">
        <div class="container">
            <h2 style="color:#2196F3;">STAGE 2: è‰²ã®è¨˜æ†¶</h2>
            <p style="font-size:clamp(0.9em, 3vw, 1.1em);">è¦‹æœ¬ã¨åŒã˜é †ç•ªã§è‰²ã‚’ã‚¿ãƒƒãƒ—</p>
            <div id="color-pattern-display"></div>
            <div id="color-input-grid"></div>
            <p id="color-msg" class="error-msg"></p>
            <p>æ®‹ã‚Šãƒãƒ£ãƒ³ã‚¹: <span id="color-attempts" class="highlight-red">3</span> å›</p>
        </div>
    </div>

    <script>
        /* --- iOSå¯¾å¿œéŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ  --- */
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let audioInitialized = false;
        
        // iOSå¯¾å¿œã®éŸ³å£°åˆæœŸåŒ–
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                
                // iOSã®ãŸã‚ã®ç„¡éŸ³å†ç”Ÿ
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
                
                audioInitialized = true;
                console.log('Audio initialized');
            }
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        // ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚µãƒ¼ã¨ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³
        let compressor = null;
        let masterGain = null;
        
        function setupAudioNodes() {
            if (!audioCtx) initAudio();
            
            if (!compressor) {
                compressor = audioCtx.createDynamicsCompressor();
                compressor.threshold.setValueAtTime(-50, audioCtx.currentTime);
                compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
                compressor.connect(audioCtx.destination);
            }
            
            if (!masterGain) {
                masterGain = audioCtx.createGain();
                masterGain.connect(compressor);
            }
        }

        function playSound(type) {
            if (!audioCtx || !masterGain) {
                setupAudioNodes();
            }
            
            // iOSã®ãŸã‚ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†é–‹
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            const t = audioCtx.currentTime;
            masterGain.gain.cancelScheduledValues(t);
            masterGain.gain.setValueAtTime(1.0, t);

            if (type === 'HEAVY') {
                // é‡ä½éŸ³ãƒ‘ã‚¿ãƒ¼ãƒ³
                for (let i = 0; i < 2; i++) {
                    const osc = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    osc.frequency.setValueAtTime(150 + i * 50, t + i * 0.1);
                    osc.frequency.exponentialRampToValueAtTime(30, t + 0.5 + i * 0.1);
                    g.gain.setValueAtTime(1, t + i * 0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, t + 0.5 + i * 0.1);
                    osc.connect(g).connect(masterGain);
                    osc.start(t + i * 0.1);
                    osc.stop(t + 0.5 + i * 0.1);
                }
                
                // ãƒ‘ãƒ«ã‚¹éŸ³
                const osc2 = audioCtx.createOscillator();
                const g2 = audioCtx.createGain();
                osc2.type = 'square';
                osc2.frequency.setValueAtTime(100, t);
                osc2.frequency.exponentialRampToValueAtTime(10, t + 0.1);
                g2.gain.setValueAtTime(0.3, t);
                g2.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc2.connect(g2).connect(masterGain);
                osc2.start(t);
                osc2.stop(t + 0.1);

            } else if (type === 'MOSQUITO') {
                // é«˜å‘¨æ³¢ãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆéŸ³
                for (let i = 0; i < 3; i++) {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(4000 + i * 500, t + i * 0.05);
                    osc.frequency.linearRampToValueAtTime(6000 + i * 300, t + 0.2 + i * 0.05);
                    const g = audioCtx.createGain();
                    g.gain.setValueAtTime(0.3, t + i * 0.05);
                    g.gain.linearRampToValueAtTime(0, t + 0.3 + i * 0.05);
                    osc.connect(g).connect(masterGain);
                    osc.start(t + i * 0.05);
                    osc.stop(t + 0.3 + i * 0.05);
                }
            } else {
                // ã‚µã‚¤ãƒ¬ãƒ³éŸ³
                for (let i = 0; i < 2; i++) {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800 + i * 200, t + i * 0.15);
                    osc.frequency.linearRampToValueAtTime(1200 + i * 200, t + 0.3 + i * 0.15);
                    const g = audioCtx.createGain();
                    g.gain.setValueAtTime(0.2, t + i * 0.15);
                    osc.connect(g).connect(masterGain);
                    osc.start(t + i * 0.15);
                    osc.stop(t + 0.3 + i * 0.15);
                }
            }
            
            // iOSå‘ã‘ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œã—ã¦ã„ã‚‹å ´åˆï¼‰
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
            }
        }
        
        /* --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° --- */
        let alarmTimer = null;
        let soundInterval = null;
        let moveInterval = null;
        let isAlarming = false;
        let mathAnswer = 0;
        
        // é€ƒèµ°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚²ãƒ¼ãƒ ç”¨
        const GAME_GOAL = 5;
        let gameClickCount = 0;

        // é…è‰²ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ç”¨
        const COLOR_PATTERN_LENGTH = 4;
        const MAX_ATTEMPTS = 3;
        let colorGamePattern = [];
        let colorGameInput = [];
        let colorGameAttempts = MAX_ATTEMPTS;

        // è¦ç´ å–å¾—
        const screens = {
            setup: document.getElementById('setup-screen'),
            countdown: document.getElementById('countdown-screen'),
            math: document.getElementById('stage-math'),
            game: document.getElementById('stage-game'),
            color: document.getElementById('stage-color')
        };

        // --- iOSåˆæœŸåŒ– ---
        const iosInitDiv = document.getElementById('ios-init');
        const btnInitAudio = document.getElementById('btn-init-audio');
        
        // iOS/Safariæ¤œå‡º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        if (isIOS || isSafari) {
            iosInitDiv.style.display = 'flex';
        }
        
        btnInitAudio.addEventListener('click', () => {
            initAudio();
            iosInitDiv.style.display = 'none';
            // ãƒ†ã‚¹ãƒˆéŸ³ã‚’é³´ã‚‰ã™
            playSound('SIREN');
            setTimeout(() => {
                if (soundInterval) clearInterval(soundInterval);
            }, 300);
        });

        // --- åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ ---
        function resetAll() {
            isAlarming = false;
            if(soundInterval) clearInterval(soundInterval);
            if(alarmTimer) clearInterval(alarmTimer);
            if(moveInterval) clearInterval(moveInterval);
            document.body.style.backgroundColor = "#000";
            
            Object.values(screens).forEach(screen => screen.style.display = 'none');
            screens.setup.style.display = 'block';
        }

        function startAlarm() {
            isAlarming = true;
            screens.countdown.style.display = 'none';
            screens.math.style.display = 'flex';
            
            // éŸ³å£°åˆæœŸåŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (!audioInitialized) {
                initAudio();
            }

            const mode = document.getElementById('sound-mode').value;
            soundInterval = setInterval(() => {
                playSound(mode);
            }, 600);

            generateMath();
        }

        function generateMath() {
            const a = Math.floor(Math.random() * 40) + 10;
            const b = Math.floor(Math.random() * 40) + 10;
            mathAnswer = a + b;
            document.getElementById('math-q').innerText = `${a} + ${b}`;
            document.getElementById('math-a').value = '';
            document.getElementById('math-a').focus();
            document.getElementById('math-msg').innerText = '';
        }

        function checkMath() {
            const input = parseInt(document.getElementById('math-a').value);
            const msg = document.getElementById('math-msg');
            
            if (input === mathAnswer) {
                const gameChoice = Math.random();
                if (gameChoice < 0.5) {
                    startMiniGame();
                } else {
                    startColorGame();
                }
            } else {
                msg.innerText = "ä¸æ­£è§£ï¼éŸ³ãŒæ­¢ã¾ã‚‰ãªã„ï¼";
                playSound('SIREN');
                document.getElementById('math-a').value = '';
                setTimeout(() => { msg.innerText = ''; }, 2000);
            }
        }
        
        document.getElementById('btn-math-submit').addEventListener('click', checkMath);
        document.getElementById('math-a').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkMath();
        });

        // --- STAGE 2A: é€ƒèµ°ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚²ãƒ¼ãƒ  ---
        function startMiniGame() {
            screens.math.style.display = 'none';
            screens.game.style.display = 'block';
            gameClickCount = 0;
            updateGameDisplay();
            
            if (moveInterval) clearInterval(moveInterval);
            moveInterval = setInterval(moveTarget, 500);
            moveTarget();
        }

        function updateGameDisplay() {
            const remain = GAME_GOAL - gameClickCount;
            document.getElementById('game-count').innerText = remain;
            if (remain <= 0) {
                finishAlarm();
            }
        }

        function moveTarget() {
            const btn = document.getElementById('game-target-btn');
            const x = Math.floor(Math.random() * 70) + 10;
            const y = Math.floor(Math.random() * 70) + 10;
            btn.style.left = x + '%';
            btn.style.top = y + '%';
        }

        document.getElementById('game-target-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            gameClickCount++;
            
            // ã‚¯ãƒªãƒƒã‚¯éŸ³
            if (audioCtx) {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
            
            updateGameDisplay();
        });

        document.getElementById('game-bg-click-area').addEventListener('click', (e) => {
            e.preventDefault();
            if (gameClickCount > 0) {
                gameClickCount = 0;
                updateGameDisplay();
                
                // ã‚¨ãƒ©ãƒ¼éŸ³
                if (audioCtx) {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                    osc.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.3);
                }
                
                alert("ãƒŸã‚¹ï¼å›æ•°ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸï¼");
                moveTarget();
            }
        });

        // --- STAGE 2B: é…è‰²ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ  ---
        function startColorGame() {
            if (moveInterval) clearInterval(moveInterval);

            screens.math.style.display = 'none';
            screens.color.style.display = 'flex';
            
            colorGameInput = [];
            colorGameAttempts = MAX_ATTEMPTS;
            document.getElementById('color-attempts').innerText = colorGameAttempts;

            if (!document.getElementById('color-input-grid').hasChildNodes()) {
                createColorButtons();
            }
            generateColorPattern();
        }

        function generateColorPattern() {
            const colors = ['#FF4D4D', '#2196F3', '#00E676', '#FFEB3B'];
            colorGamePattern = [];
            for (let i = 0; i < COLOR_PATTERN_LENGTH; i++) {
                colorGamePattern.push(colors[Math.floor(Math.random() * colors.length)]);
            }

            const display = document.getElementById('color-pattern-display');
            display.innerHTML = '';
            
            colorGamePattern.forEach(color => {
                const block = document.createElement('div');
                block.style.cssText = `width: ${100 / COLOR_PATTERN_LENGTH}%; height: 100%; float: left; background-color: ${color};`;
                display.appendChild(block);
            });

            setTimeout(() => {
                display.innerHTML = '<span style="color:#fff; line-height:50px;">è¦šãˆãŸé †ç•ªã«å…¥åŠ›é–‹å§‹ï¼</span>';
                colorGameInput = [];
                Array.from(document.getElementById('color-input-grid').children).forEach(btn => btn.style.border = 'none');
            }, 1500);
        }

        function createColorButtons() {
            const colors = ['#FF4D4D', '#2196F3', '#00E676', '#FFEB3B'];
            const grid = document.getElementById('color-input-grid');
            
            colors.forEach(color => {
                const button = document.createElement('button');
                button.style.backgroundColor = color;
                button.setAttribute('data-color', color);
                button.addEventListener('click', handleColorInput);
                button.addEventListener('touchstart', (e) => e.preventDefault());
                grid.appendChild(button);
            });
        }

        function handleColorInput(e) {
            e.preventDefault();
            const selectedColor = e.target.getAttribute('data-color');
            colorGameInput.push(selectedColor);
            
            e.target.style.border = '3px solid #ffeb3b';
            setTimeout(() => { e.target.style.border = 'none'; }, 200);

            if (colorGameInput.length === COLOR_PATTERN_LENGTH) {
                checkColorPattern();
            }
        }

        function checkColorPattern() {
            const msg = document.getElementById('color-msg');
            
            const isCorrect = colorGameInput.every((color, index) => color === colorGamePattern[index]);

            if (isCorrect) {
                msg.innerText = "æˆåŠŸï¼è­¦å ±åœæ­¢ï¼";
                setTimeout(finishAlarm, 500);
            } else {
                colorGameAttempts--;
                document.getElementById('color-attempts').innerText = colorGameAttempts;
                msg.innerText = `é–“é•ã„ã§ã™ã€‚æ®‹ã‚Š ${colorGameAttempts} å›`;

                if (colorGameAttempts <= 0) {
                    msg.innerText = "æœ€çµ‚å¤±æ•—ï¼ç®—æ•°ã‹ã‚‰ã‚„ã‚Šç›´ã—ï¼";
                    setTimeout(() => {
                        screens.color.style.display = 'none';
                        startAlarm();
                    }, 1000);
                } else {
                    colorGameInput = [];
                    generateColorPattern();
                }
            }
        }

        // å®Œå…¨åœæ­¢
        function finishAlarm() {
            if (moveInterval) clearInterval(moveInterval);
            resetAll();
            alert("ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ï¼å®Œå…¨è¦šé†’ã—ã¾ã—ãŸï¼");
        }

        /* --- ã‚¿ã‚¤ãƒãƒ¼è¨­å®š --- */
        document.getElementById('btn-set').addEventListener('click', () => {
            // éŸ³å£°åˆæœŸåŒ–
            if (!audioInitialized) {
                initAudio();
            }

            const h = parseInt(document.getElementById('alarm-h').value);
            const m = parseInt(document.getElementById('alarm-m').value);
            const ms = (h * 60 + m) * 60 * 1000;

            if (ms <= 0) return alert("æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„");

            screens.setup.style.display = 'none';
            screens.countdown.style.display = 'block';

            const endTime = new Date().getTime() + ms;
            
            if(alarmTimer) clearInterval(alarmTimer);
            alarmTimer = setInterval(() => {
                const left = endTime - new Date().getTime();
                if (left <= 0) {
                    clearInterval(alarmTimer);
                    startAlarm();
                } else {
                    const hh = Math.floor(left / 3600000);
                    const mm = Math.floor((left % 3600000) / 60000);
                    const ss = Math.floor((left % 60000) / 1000);
                    document.getElementById('timer-display').innerText = 
                        `${hh}:${mm<10?'0'+mm:mm}:${ss<10?'0'+ss:ss}`;
                }
            }, 1000);
        });

        document.getElementById('btn-cancel').addEventListener('click', resetAll);
        
        // å…¨ä½“ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§éŸ³å£°åˆæœŸåŒ–ï¼ˆiOSå¯¾å¿œï¼‰
        document.addEventListener('touchstart', () => {
            if (!audioInitialized) {
                initAudio();
            }
        }, { once: true });
        
        // iOSã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
